from dash import dash_table
import dash_uploader as du
from dash_extensions import EventListener
import dash_daq as daq
import dash_ag_grid as dag
import dash_mantine_components as dmc
from plotly.graph_objs.layout import YAxis, XAxis
from dash import dcc, html
import dash_bootstrap_components as dbc
import dash_tour_component
from rakaia.entrypoint import __version__
from rakaia.utils.alert import DataImportTour, ToolTips
from rakaia.io.session import SessionTheme, TabText
from rakaia.inputs.pixel import (
    render_default_annotation_canvas,
    add_local_file_dialog)
from rakaia.inputs.loaders import wrap_child_in_loading
from rakaia.utils.pixel import generate_default_swatches
from rakaia.utils.region import RegionStatisticGroups


def register_app_layout(config, cache_dest):

    # set the default colours for the swatches from the config input
    DEFAULT_SWATCHES = generate_default_swatches(config)
    DEFAULT_WIDGET_COLOUR = SessionTheme().widget_colour
    TOOLTIPS = ToolTips().tooltips

    return html.Div([
        dash_tour_component.DashTour(accentColor=DEFAULT_WIDGET_COLOUR,
            steps= DataImportTour().steps, isOpen=False, id="tour_component"),
        # this is the generic error modal that will pop up on specific errors return by the alert dict
        dbc.Modal(children=dbc.ModalBody([html.Div(id='alert-information', style={'whiteSpace': 'pre-line'})]),
                  id="alert-modal", size='xl'),
        # this modal is for the fullscreen view and does not belong in a nested tab
        dbc.Modal(children=[dbc.ModalHeader(),
            dbc.ModalBody
            ([render_default_annotation_canvas(input_id="annotation_canvas-fullscreen",
                                                fullscreen_mode=True)])],
            id="fullscreen-canvas", fullscreen=True, size='xl',
        centered=True, style={"margin": "auto", "width": "100vw", "height": "100vh",
                              "max-width": "none", "max-height": "none"}),
        dbc.Modal(children=dbc.ModalBody([html.H6(TabText().dataset_preview),
                html.Div([dash_table.DataTable(id='dataset-preview-table', columns=[], data=None,
                                     style_table={"max-width": "inherit"},
                editable=False, filter_action='native', row_selectable='single', column_selectable='single')],
                style={"max-width": "2000px"}),
                html.Br(),
                dbc.Button(children=html.Span([html.Abbr(html.I(className="fa fa-trash",
                style={"display": "iflex"}))], style={"width": "100vw"}),
                id="remove-collection", color=None, n_clicks=0,
                style={"margin-top": "-5px", "height": "10%"}),
                dbc.Tooltip(TOOLTIPS['delete-selection'], target="remove-collection")]),
                  id="dataset-preview", size='xl'),
        html.Header(
            className="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow",
            children=[
                html.Div([html.A("rakaia", className="navbar-brand me-0 px-3", href="#"),
                          dbc.Button(
                    children=html.Span([html.I(className="fa-solid fa-solid fa-solid fa-file-export",
                                               style={"display": "flex"}),
                                        html.H6("Import/Export", style={"color": "#FFFFFF", "margin-left": "3px"})],
                                       style={"display": "flex"}),
                    id="inputs-offcanvas-button", className="navbar-brand me-0 px-3",
                    color=None, n_clicks=0, style={"display": "inline-block", "margin-top": "5px",
                                                   "margin-left": "35px"}, outline=True)],
                    style={"float": "left", "justifyContent": "left"}),
                html.Div([
                    html.A("Documentation", id='rakaia-documentation',
                             href='https://camlab-bioml.github.io/rakaia-doc/', target="_blank",
                           style={"display": "flex", "margin-top": "7.5px", "color": "#FFFFFF",
                                  "text-decoration": "None", "margin-right": "10px"}),
                    dbc.Button(
                    children=html.Span([html.I(className="fa-solid fa-gears",
                                               style={"display": "inline-block"}),
                                        ]),
                    id="session-config-modal-button", className="navbar-brand me-0 px-3",
                    color=None, n_clicks=0, style={"display": "flex"}, outline=True),
                dbc.Modal(children=dbc.ModalBody([
                    html.H5("Additional application settings"),
                    dbc.Tabs([dbc.Tab(
                        label='Session', label_style={"color": DEFAULT_WIDGET_COLOUR},
                    children=[
                        html.Br(),
                        html.Div([html.B("Select dataset identifier delimiter", style={"margin-right": "20px"}),
                                  dcc.Input(id="dataset-delimiter", value="+++", type="text", debounce=True,
                                            persistence=config['persistence'], persistence_type='local',
                                            style={"width": "20%"}),
                                  dbc.Tooltip(TOOLTIPS['delimiter'], target="dataset-delimiter")],
                                 style={"display": "flex"}),
                        html.Br(),
                        html.Div([daq.ToggleSwitch(label='Natural sort input files', id='natsort-uploads',
                                                   labelPosition='bottom', color=DEFAULT_WIDGET_COLOUR, value=True,
                                                   persistence=config['persistence'], persistence_type='local',
                                                   style={"margin": "10px"}),
                                  daq.ToggleSwitch(label='ROI change using arrows', id='enable-roi-change-key',
                                                   labelPosition='bottom', color=DEFAULT_WIDGET_COLOUR, value=True,
                                                   persistence=config['persistence'], persistence_type='local',
                                                   style={"margin": "10px"}),
                                  daq.ToggleSwitch(label='Switch tool panel placement', id='toggle-advanced-placement',
                                                   labelPosition='bottom', color=DEFAULT_WIDGET_COLOUR, value=False,
                                                   persistence=config['persistence'], persistence_type='local',
                                                   style={"margin": "10px", "width": "35%",
                                                          "textAlign": "center"}),
                                  ], style={"display": "flex",
                                                "justify-content": "center", "textAlign": "center"}),
                        html.Br(),
                        html.Div([daq.ToggleSwitch(label='Session messages', id='toggle-session-messages',
                                                   labelPosition='bottom', color=DEFAULT_WIDGET_COLOUR, value=True,
                                                   persistence=config['persistence'], persistence_type='local',
                                                   style={"margin-left": "10px", "width": "50%",
                                                          "textAlign": "center"}),
                                  html.Div([html.B("Max viewport", style={"margin-right": "20px"}),
                                            dcc.Input(id='canvas-viewport-max', type='number', value=150, debounce=True,
                                                      style={"width": "40%", "height": "50%"},
                                                      persistence=config['persistence'], persistence_type='local'),
                                            dbc.Tooltip(TOOLTIPS['max-viewport'], target="canvas-viewport-max")
                                            ], style={"display": "flex"}),
                                  ],
                                 style={"display": "flex", "justify-content": "center"}),
                        html.Br(),
                        dcc.Checklist(options=[' use graph subset on download'], value=[],
                                      id="graph-subset-download", style={"margin-top": "12px",
                                                                         "accent-color": DEFAULT_WIDGET_COLOUR}),
                        html.Br(),
                        html.Div([
                            html.Div([
                                dcc.Input(id="set-preset", type="text",
                                          placeholder="Create a preset from the current channel", value=None,
                                          style={"width": "65%", "margin-right": "10px"}),
                                dbc.Button("Create preset", id="preset-button", className="me-1",
                                           style={"background-color": DEFAULT_WIDGET_COLOUR, "width": "30%"}),
                            ], style={"display": "flex", "float": "center", "textAlign": "center", "width": "90%"}),
                            html.Br(),
                            dcc.Dropdown(options=[], value=None, id='preset-options', style={"width": "75%"}),
                            dbc.Tooltip(children="", target="preset-options",
                                        id="hover-preset-information", trigger="hover"),
                        html.Br(),
                        ], style={"display": "inline-block", "float": "center", "textAlign": "center", "width": "100%"}),
                    ], style={"margin": "5px"}),
                    dbc.Tab(label='Appearance', label_style={"color": DEFAULT_WIDGET_COLOUR},
                    children=[
                        html.Div([daq.ToggleSwitch(label='Canvas scroll zoom', id='enable-canvas-scroll-zoom',
                                                   labelPosition='bottom', color=DEFAULT_WIDGET_COLOUR, value=False,
                                                   persistence=config['persistence'], persistence_type='local',
                                                   style={"margin": "10px"}),
                                  daq.ToggleSwitch(label='Autofill channel colours', id='autofill-channel-colors',
                                                   labelPosition='bottom', color=DEFAULT_WIDGET_COLOUR, value=False,
                                                   persistence=config['persistence'], persistence_type='local',
                                                   style={"margin": "10px"})],
                                    style={"display": "flex", "justify-content": "center", "textAlign": "center"}),
                    html.Br(),
                    html.Div([html.B("Set annotation circle radius", style={"margin-right": "20px"}),
                                  dcc.Input(id='annotation-circle-size', type='number', value=4, style={"width": "25%",
                                "margin-top": "-3px"},
                    persistence=config['persistence'], persistence_type='local')], style={"display": "flex"}),
                    html.Br(),
                        html.Div([html.B("Legend orientation"),
                                  dcc.RadioItems(['vertical', 'horizontal'], 'vertical', inline=True,
                                                 id="legend_orientation",
                                                 persistence=config['persistence'], persistence_type='local',
                                                 style={"accent-color": DEFAULT_WIDGET_COLOUR}),
                                  html.Br(),
                                  html.B("Scalebar color"),
                                  dcc.RadioItems(['white', 'black'], 'white', inline=True, id="scalebar-color",
                                                 persistence=config['persistence'], persistence_type='local',
                                                 style={"accent-color": DEFAULT_WIDGET_COLOUR})],
                                 style={"display": "flex"}),
                    html.Br(),
                    ], style={"margin": "5px"})]),
                    html.H6(f"Session cache: {cache_dest}"),
                ]),
                        id="session-config-modal", size='l',
                        style={"margin-left": "10px", "margin-top": "15px"}),
                html.A(f"v{__version__}", className="navbar-brand me-0 px-3", href="#")], style={"display": "flex"})],
            style={"margin-bottom": "7.5px", "display": "flex", "height": "40%"}),
            html.Div([dcc.Dropdown(id='data-collection', multi=False, options=[],
                placeholder='Load an ROI into the canvas', style={'justifyContent': 'right', 'white-space':'initial',
                                                           'overflow-wrap': 'anywhere'}),
                dbc.Tooltip(None, target="data-collection", id='data-collection-tooltip')],
            style={'width': '40%', 'justifyContent': 'right', 'float': 'right', 'display': 'inline-block',
                   'padding': '0px', 'white-space':'initial', 'word-wrap': 'break-word'}),
            dbc.Tab(label='Image annotation', tab_id='image-annotation',
                    active_label_style={"color": DEFAULT_WIDGET_COLOUR},
                    children=[
                html.Div([dbc.Tabs(id='main-tabs',
                children=[dbc.Tab(# label_class_name="fa-regular fa-file-image",
                                  label="Canvas",
                                  label_style={"color": DEFAULT_WIDGET_COLOUR},
                                  # label_style={"text-transform": "capitalize", "font-weight": "normal"},
                tab_id='pixel-analysis',
                children=[
                    dbc.Offcanvas(
                        id="inputs-offcanvas",
                        # title=html.Div(["Configure inputs/export"],
                        # style={"display": "flex", "justifyContent": "left",
                        #        "#header": {"visibility": "hidden"}}),
                        title=None,
                        close_button=False,
                        is_open=True,
                        children=[
                                dbc.Tabs(id='data-config',
                                children=[dbc.Tab(id='file-data-config', label='File import',
                                                  label_style={"color": DEFAULT_WIDGET_COLOUR},
                                children=[
                                html.Br(),
                                html.Div([html.H5("Step 1: Import images", style={'width': '50%'}),
                                dbc.Button(children=html.Span([html.I(className="fa-solid fa-circle-question",
                                style={"display": "inline-block", "margin-right": "7.5px",
                                "margin-top": "-5px"})],
                                style={"display": "flex"}), id="dash-import-tour",
                                className="mb-3", color=None, n_clicks=0, style={"width": "10%",
                                    "margin-top": "-3px"})], style={"display": "flex"}),
                                dbc.Tooltip(TOOLTIPS['import-tour'], target="dash-import-tour"),
                                du.Upload(id='upload-image', max_file_size=50000,
                                text='Import imaging data (.MCD, .tiff, .txt, etc.) files using drag and drop',
                                              chunk_size=100,
                                              max_total_size=50000, max_files=200,
                                              filetypes=['png', 'tif', 'tiff', 'h5', 'mcd', 'txt'],
                                              default_style={"margin-top": "12.5px",
                                                             "height": "7.5vh"}),
                                    html.H5("or", style={'width': '35%', 'margin-top': '5px'}),
                                    dcc.Input(id="read-filepath", type="text",
                                    placeholder="Read imaging data directly from filepath or directory (local runs only)",
                                              value=None, style={"width": "100%", "height": "10%"}),
                                    html.Br(),
                                    html.Div([dbc.Button("Import local", id="add-file-by-path",
                                    className="mb-3", color="primary", n_clicks=0,
                                    style={"margin-top": "10px", "background-color": DEFAULT_WIDGET_COLOUR})],
                                             style={"display": "flex"}),
                                    add_local_file_dialog(use_local_dialog=config['use_local_dialog']),
                                    dbc.Tooltip(TOOLTIPS['local-dialog'], target="local-dialog-file"),
                                    html.Div([html.Span([
                                        dbc.Button(children=html.Span([html.I(className="fa-solid fa-circle-info",
                                                                              style={"display": "inline-block",
                                                                                     "margin-right": "7.5px",
                                                                                     "margin-top": "3px"}),
                                                                       html.Div("ROI List")],
                                                                      style={"display": "flex"}),
                                                   id="show-dataset-info",
                                                   className="mb-3", color="primary", n_clicks=0,
                                                   style={"margin-top": "10px", "background-color": DEFAULT_WIDGET_COLOUR})],
                                        style={"width": "100%"}),
                                        html.Br(),
                                        html.Br(),
                                        html.H5("Step 2: Optional imports", style={'width': '50%'}),
                                        html.H6("Mask"),
                                        dbc.Modal(children=dbc.ModalBody(
                                            [html.H6("Set the label for the imported mask"),
                                             html.Div([dcc.Input(id="input-mask-name", type="text", value=None,
                                                                 style={"width": "65%", "margin-right": "10px",
                                                                        "height": "50%"})],
                                                      style={"display": "flex"}),
                                        html.Br(),
                                        html.Div([dbc.Button("Autofill with ROI name", id="mask-name-autofill",
                                        className="me-1", size="sm", color='dark', outline=True,
                                        style={"height": "50%", "margin-top": "3px", "margin-right": "10px"}),
                                        dbc.Tooltip(TOOLTIPS['mask-name-autofill'], target="mask-name-autofill"),
                                        dbc.Button("Set mask import", id="set-mask-name", className="me-1",
                                        style={"background-color": DEFAULT_WIDGET_COLOUR, "margin-left": "10px"})],
                                        style={"display": "flex", "justifyContent": "center"}),
                                        html.Br()]),
                                            id="mask-name-modal", size='l',
                                            style={"margin-left": "10px", "margin-top": "15px"}),
                                        du.Upload(id='upload-mask', max_file_size=50000,
                                                  text='Import mask (tiff) using drag and drop',
                                                  max_total_size=50000, max_files=1000,
                                                  chunk_size=100,
                                                  filetypes=['tif', 'tiff'],
                                                  default_style={"margin-top": "20px", "height": "5vh"}),
                                        html.Br(),
                                        html.H6("Quantification results/measurements"),
                                        du.Upload(id='upload-quantification', max_file_size=5000,
                                                  filetypes=['h5ad', 'h5', 'csv'],
                                                  text='Import quantification results (CSV, h5ad) using drag and drop',
                                                  max_files=1, upload_id="upload-quantification",
                                                  default_style={"margin-top": "20px", "height": "5vh"}),
                                        html.Br(),
                                        html.H6("ROI configuration"),
                                        du.Upload(id='upload-param-json', max_file_size=1000,
                                                  filetypes=['json'],
                                                  text='Import channel blend parameters (JSON) using drag and drop',
                                                  max_files=1, upload_id="upload-param-json",
                                                  default_style={"margin-top": "20px", "height": "5vh"}),
                                        html.Br(),
                                        dbc.Button(children=html.Span([html.I(className="fa-solid fa-file-import",
                                        style={"display": "inline-block", "margin-right": "7.5px",
                                        "margin-top": "3px"}),
                                        html.Div("Show/hide additional imports")],
                                        style={"display": "flex", "margin-top": "10px"}),
                                                   id="show-collapse-extra-imports",
                                                   className="mx-auto", color="light", n_clicks=0,
                                                   style={"display": "flex", "width": "auto", "align-items": "center",
                                                          "float": "center", "justify-content": "center"}),
                                        dbc.Collapse([
                                            html.H6("Panel info list"),
                                            du.Upload(id='upload-panel-info', max_file_size=1000, max_files=1,
                                                      text='Import panel info (CSV) using drag and drop',
                                                      filetypes=['csv'], upload_id="upload-image",
                                                      default_style={"margin-top": "20px", "height": "5vh"}),
                                            html.Br(),
                                            html.H6("Click-point annotations/coordinate lists"),
                                            du.Upload(id='upload-point-annotations', max_file_size=5000, max_files=1,
                                                      text='Re-import point/ click annotations (CSV) and add to canvas',
                                                      filetypes=['csv'], upload_id="upload-point-annotations",
                                                      default_style={"margin-top": "20px", "height": "5vh"}),
                                            html.Br(),
                                            html.H6("UMAP coordinates"),
                                            du.Upload(id='upload-umap-coordinates', max_file_size=10000,
                                                      text='Import UMAP coordinates (CSV)',
                                                      chunk_size=100, max_total_size=10000, max_files=1,
                                                      filetypes=['csv'],
                                                      default_style={"margin-top": "20px", "height": "5vh"})
                                        ], id='extra-import-collapse'),
                                    ],
                                        style={'width': '100%', 'height': '100%', "margin-top": "5px"})
                                ]),
                                dbc.Tab(id='db-config', label='Database',
                                        label_style={"color": DEFAULT_WIDGET_COLOUR},
                                children=[
                                html.Br(),
                                dbc.Form([
                                html.Div([dbc.Label("Connection string", html_for="db-connection-string"),
                                dbc.Input(type="text", id="db-connection-string", value="rakaia-db.uzqznla.mongodb.net",
                                style={"width": "75%"}, persistence=config['persistence'],
                                persistence_type='local')], className="mb-3"),
                                html.Div([dbc.Label("Username", html_for="db-username"),
                                dbc.Input(type="text", id="db-username", placeholder="Enter username",
                                style={"width": "75%"}, persistence=config['persistence'],
                                persistence_type='local')], className="mb-3"),
                                html.Div([
                                dbc.Label("Password", html_for="db-password"),
                                dbc.Input(type="password", id="db-password", placeholder="Enter password",
                                          style={"width": "75%"}, persistence=config['persistence'],
                                          persistence_type='local'),
                                dbc.FormText("Enter your credentials for a mongoDB Atlas connection", color="secondary"),
                                ], className="mb-3")
                                ]),
                                dbc.Button(children=html.Span([html.I(className="fa-solid fa-arrow-right-to-bracket",
                                    style={"display": "inline-block", "margin-right": "7.5px",
                                        "margin-top": "3px"}), html.Div("Connect")],
                                    style={"display": "flex"}), id="db-connect",
                                               className="mb-3", color="secondary", n_clicks=0,
                                               style={"margin-top": "10px"}),
                                dcc.Loading(dbc.Alert([], color='danger', is_open=False, id='db-connect-alert'),
                                            fullscreen=False, color=DEFAULT_WIDGET_COLOUR),
                                html.Br(),
                                html.H6("Select saved configuration"),
                                dcc.Dropdown(id='db-config-options', multi=False, style={"width": "87%"}),
                                html.Br(),
                                html.Br(),
                                html.Br(),
                                dbc.Button("View saved configurations", id="view-db-config-list",
                                style={"width": "50%", "background-color": DEFAULT_WIDGET_COLOUR}),
                                dbc.Modal(children=dbc.ModalBody(
                                [dash_table.DataTable(id='db-config-preview-table', columns=[], data=None,
                                                              editable=False, filter_action='native',
                                                              row_selectable='single',
                                                              column_selectable='single',
                                                      )]),
                                id='db-config-preview', size='xl'),
                                html.Br(),
                                html.Br(),
                                dcc.Loading(dbc.Alert([], color='success', is_open=False, duration=1500,
                                        id='db-config-submit-alert'), fullscreen=False, color=DEFAULT_WIDGET_COLOUR),
                                html.Div([
                                dbc.Input(type="text", id="db-config-name", placeholder="Enter configuration name",
                                                  style={"width": "75%"}),
                                dbc.FormText("Set the name of the current configuration to save to the database",
                                color="secondary"),
                                    ], className="mb-3"),
                                dbc.Button(children=html.Span([html.I(className="fa-solid fa-database",
                                style={"display": "inline-block", "margin-right": "7.5px",
                                "margin-top": "3px"}), html.Div("Save current session")],
                                    style={"display": "flex"}), id="db-save-cur-config",
                                        className="mb-3", color="dark", n_clicks=0, outline=True,
                                        style={"margin-top": "10px"}),
                                html.Br(),
                                html.Br(),
                                html.Br(),
                                dbc.Button(children=html.Span([html.I(className="fa-solid fa-trash",
                                    style={"display": "inline-block", "margin-right": "7.5px", "margin-top": "3px"}),
                                    html.Div("Remove selected config")],
                                    style={"display": "flex"}), id="db-remove-select-config",
                                        className="mb-3", color=None, n_clicks=0, outline=False,
                                        style={"margin-top": "10px"}, size='s'),
                                ]),
                                dbc.Tab(label='Export', id='config-export', label_style={"color": DEFAULT_WIDGET_COLOUR},
                                children=[
                                    html.Br(),
                                    html.H5("Download images/configurations"),
                                    html.Div([
                                        dcc.Download(id="download-canvas-image-tiff"),
                                        dbc.Button(children=html.Span([html.I(className="fa-solid fa-download",
                                                                              style={"display": "inline-block",
                                                                                     "margin-right": "7.5px",
                                                                                     "margin-top": "3px"}),
                                                                       html.Div("Canvas (tiff)")],
                                                                      style={"display": "flex"}),
                                                   id="btn-download-canvas-tiff", className="mx-auto", color=None,
                                                   n_clicks=0, style={"margin-top": "10px"}),
                                        dcc.Download(id="download-canvas-image-html"),
                                        dbc.Button(children=html.Span([html.I(className="fa-solid fa-download",
                                                                              style={"display": "inline-block",
                                                                                     "margin-right": "7.5px",
                                                                                     "margin-top": "3px"}),
                                                                       html.Div("Canvas (HTML)")],
                                                                      style={"display": "flex"}),
                                                   id="btn-download-canvas-html", className="mx-auto", color=None,
                                                   n_clicks=0, style={"margin-top": "10px"}),
                                        dcc.Download(id="download-session-config-json"),
                                        dbc.Button(children=html.Span([html.I(className="fa-solid fa-download",
                                                                              style={"display": "inline-block",
                                                                                     "margin-right": "7.5px",
                                                                                     "margin-top": "3px"}),
                                                                       html.Div("Session parameters (JSON)")],
                                                                      style={"display": "flex"}),
                                                   id="btn-download-session-config-json", className="mx-auto",
                                                   color=None,
                                                   n_clicks=0, style={"margin-top": "10px"}),
                                        dcc.Download(id="download-roi-h5py"),
                                        dbc.Button(children=html.Span([html.I(className="fa-solid fa-download",
                                                                              style={"display": "inline-block",
                                                                                     "margin-right": "7.5px",
                                                                                     "margin-top": "3px"}),
                                                                       html.Div("Entire ROI (h5py)")],
                                                                      style={"display": "flex"}),
                                                   id="btn-download-roi-h5py", className="mx-auto", color=None,
                                                   n_clicks=0, style={"margin-top": "10px"}),
                                    html.Br(),
                                        dbc.Button(children=html.Span([html.I(className="fa-solid fa-download",
                                                                              style={"display": "inline-block",
                                                                                     "margin-right": "7.5px",
                                                                                     "margin-top": "3px"}),
                                                                       html.Div("Panel info (CSV)")],
                                                                      style={"display": "flex"}),
                                                   id="btn-download-panel", className="mx-auto", color=None,
                                                   n_clicks=0, style={"margin-top": "10px"}),
                                    dcc.Download(id="download-edited-table")
                                    ], style={"border":"1px black solid", "display": "inline-block",
                                                        "width": "auto", "padding": "7.5px",
                                              "justifyContent": "center", "float": "center"}),
                                html.Br(),
                                html.Br(),
                                html.H5("Download annotations/measurements"),
                                html.Div([
                                    dbc.Button(children=html.Span([html.I(className="fa-solid fa-download",
                                                                          style={"display": "inline-block",
                                                                                 "margin-right": "7.5px",
                                                                                 "margin-top": "3px"}), html.Div(
                                        "Quantification w/ annotations (CSV)")],
                                                                  style={"display": "flex"}),
                                               id="btn-download-annotations", className="mx-auto",
                                               color=None, n_clicks=0, style={"margin-top": "10px"}),
                                    dcc.Download(id="download-edited-annotations"),
                                    dbc.Button(children=html.Span([html.I(className="fa-solid fa-download",
                                                                          style={"display": "inline-block",
                                                                                 "margin-right": "7.5px",
                                                                                 "margin-top": "3px"}),
                                                                   html.Div("Region annotations report (PDF)")],
                                                                  style={"display": "flex"}),
                                               id="btn-download-annot-pdf", className="mx-auto", color=None, n_clicks=0,
                                               style={"margin-top": "10px"}),
                                    dcc.Download(id="download-annotation-pdf"),
                                    dbc.Button(children=html.Span([html.I(className="fa-solid fa-download",
                                                                          style={"display": "inline-block",
                                                                                 "margin-right": "7.5px",
                                                                                 "margin-top": "3px"}),
                                                                   html.Div("Region annotation masks (zip)")],
                                                                  style={"display": "flex"}),
                                               id="btn-download-annot-mask", className="mx-auto", color=None,
                                               n_clicks=0, style={"margin-top": "10px"}),
                                    dcc.Download(id="download-annotation-mask"),
                                    dbc.Button(children=html.Span([html.I(className="fa-solid fa-download",
                                                                          style={"display": "inline-block",
                                                                                 "margin-right": "7.5px",
                                                                                 "margin-top": "3px"}),
                                                                   html.Div("Click-point annotations (CSV)")],
                                                                  style={"display": "flex"}),
                                               id="btn-download-points-csv", className="mx-auto", color=None,
                                               n_clicks=0, style={"margin-top": "10px"}),
                                    dcc.Download(id="download-point-csv"),
                                    dbc.Button(children=html.Span([html.I(className="fa-solid fa-download",
                                                                          style={"display": "inline-block",
                                                                                 "margin-right": "7.5px",
                                                                                 "margin-top": "3px"}),
                                                                   html.Div(
                                                                       "Annotation object lists (region/gating) (CSV)")],
                                                                  style={"display": "flex"}),
                                               id="btn-download-region-csv", className="mx-auto", color=None,
                                               n_clicks=0,
                                               style={"margin-top": "10px"}),
                                    dcc.Download(id="download-region-csv"),
                                    dbc.Button(children=html.Span([html.I(className="fa-solid fa-download",
                                                                          style={"display": "inline-block",
                                                                                 "margin-right": "7.5px",
                                                                                 "margin-top": "3px"}),
                                                                   html.Div("UMAP projection coordinates (CSV)")],
                                                                  style={"display": "flex"}),
                                               id="btn-download-umap-projection", className="mx-auto",
                                               color=None, n_clicks=0, style={"margin-top": "10px"}),
                                    dcc.Download(id="download-umap-projection")
                                ], style={"border":"1px black solid", "display": "inline-block",
                                                        "width": "auto", "padding": "7.5px"}),
                                html.Br(),
                                html.Br(),
                                dbc.Spinner(html.Div([], id='status-div'), color="dark"),
                                ])],
                                style={"margin-top": "-15px", "padding": "0px"})],
                    style={"width": "37.5%", "padding": "5px", "margin-bottom": "0px",
                           "#header": {"display": "None", "margin-top": "7.5px"}}, scrollable=True),
                    html.Div([dbc.Row([dbc.Col(html.Div([
                        dbc.Row([
                        dbc.Col([
                            html.Div([render_default_annotation_canvas(input_id="annotation_canvas")],
                                     style={"width": "100%", "margin-top": "-2px", "padding": "0px",
                                            "justifyContent": "center",
                                            "float": "center", "display": "flex"}, id="canvas-div-holder"),
                        ], style={"display": "inline-block", "padding": "0px"}, width=12)]),
                    ], style={"margin-top": "5px"}), width=9),
                        dbc.Col([
                            html.Div([
                                html.Div([
                                    html.H5("Select channels",
                                            style={'width': '100%', "margin-top": "10px", "text-align": "left"}),
                                    dcc.Checklist(options=[' sort (A-z)'], value=[],
                                                  id="sort-channels-alpha", style={"margin-top": "10px", "width": "50%",
                                                "accent-color": DEFAULT_WIDGET_COLOUR, "text-align": "left"},
                                                  persistence=config['persistence'], persistence_type='local'),
                                ], style={"display": "flex", "float": "center", "margin-left": "15px",
                                          "margin-right": "15px", "justifyContent": "center", "width": "100%"}),
                                dcc.Dropdown(id='image_layers', multi=True, value=[],
                                             placeholder='Add channels to canvas blend',
                                             style={"margin": "3px", "width": "100%", "padding": "5px", "height": "25%"}),
                            dbc.Tabs([
                                dbc.Tab(label='Canvas', tab_id='canvas-config-tab',
                                    label_style={"color": DEFAULT_WIDGET_COLOUR}, children=[
                                    html.Div([
                                        html.Div([
                                        html.Br(),
                                            html.Div([
                                                dcc.Slider(50, 150, 2.5, value=100, id='annotation-canvas-size',
                                                           persistence=config['persistence'], persistence_type='local',
                                                           marks={50: 'small', 100: 'default', 150: 'large'})],
                                                style={"width": "45vh", "height": "10%", "padding": "0px",
                                                       "margin-bottom": "-2px", "float": "right", "color": "#FFFFFF"}),
                                            html.Br(),
                                            html.Div([
                                                dbc.Button(children=html.Span([html.Div("Prev ROI"),
                                                                               html.I(
                                                                                   className="fa-solid fa-arrow-left",
                                                                                   style={"display": "inline-block"})],
                                                                              style={"width": "85vw",
                                                                                     "margin-top": "-5px",
                                                                                     "margin-bottom": "10px"}),
                                                           id="prev-roi", color=None, n_clicks=0, size='xs',
                                                           style={"margin-left": "7.5px", "height": "100%",
                                                                  "width": "auto"}),
                                                dbc.Button(children=html.Span([html.Div("Next ROI"),
                                                                               html.I(
                                                                                   className="fa-solid fa-arrow-right",
                                                                                   style={"display": "inline-block"})],
                                                                              style={"width": "85vw",
                                                                                     "margin-top": "-5px",
                                                                                     "margin-bottom": "5px"}),
                                                           id="next-roi", color=None, n_clicks=0, size='xs',
                                                           style={"margin-left": "7.5px", "height": "100%",
                                                                  "width": "auto"}),
                                                dbc.Button(
                                                    children=html.Span([html.Div("Fullscreen"),
                                                                        html.I(className="fa-solid fa-display",
                                                                               style={"display": "inline-block"})],
                                                                       style={"margin-top": "-5px",
                                                                              "margin-bottom": "10px"}),
                                                    id="make-canvas-fullscreen", color='dark', n_clicks=0, outline=True,
                                                    style={"margin-left": "7.5px",
                                                           "margin-top": "0px", "height": "100%", "float": "center",
                                                           "justifyContent": "center"})
                                            ], style={"display": "flex", "textAlign": "center", "width": "100%",
                                                      "padding": "7px", "float": "center",
                                                      "justifyContent": "center"}),
                                            html.Div([
                                                daq.ToggleSwitch(label='Toggle legend', id='toggle-canvas-legend',
                                                                 labelPosition='bottom', value=True,
                                                                 color=DEFAULT_WIDGET_COLOUR, style={"width": "30%",
                                                                                                     "margin-left": "5px"},
                                                                 persistence=config['persistence'],
                                                                 persistence_type='local'),
                                                daq.ToggleSwitch(label='Toggle scalebar', id='toggle-canvas-scalebar',
                                                                 labelPosition='bottom', value=True,
                                                                 color=DEFAULT_WIDGET_COLOUR,
                                                                 style={"width": "30%", "margin-left": "5px"},
                                                                 persistence=config['persistence'],
                                                                 persistence_type='local'),
                                            ], style={"display": "flex", "textAlign": "center", "width": "100%",
                                                      "margin": "3px", "padding": "3px", "float": "center",
                                                      "justifyContent": "center"}),
                                            html.Div(style={"height": "100%", "width": "100%",
                                                            "textAlign": "center", "display": "flex", "float": "center",
                                                            "justifyContent": "center"},
                                                     id="bound-shower"),
                                            dbc.Button(
                                                children=html.Span([html.I(className="fa-solid fa-gears",
                                                                           style={"display": "inline-block",
                                                                                  "margin-right": "3px"}),
                                                                    html.Div("Configure, annotate, measure, & more"),
                                                                    ]),
                                                id="blend-offcanvas-button", className="mx-auto",
                                                color=None, n_clicks=0, style={"display": "flex", "width": "90%",
                                                                               "margin-top": "10px",
                                                                               "align-items": "center",
                                                                               "float": "center",
                                                                               "justify-content": "center"}),
                                            dbc.Button(children=html.Span([html.I(className="fa-solid fa-list",
                                                                                  style={"display": "inline-block",
                                                                                         "margin-right": "7.5px",
                                                                                         "margin-top": "3px"}),
                                                                           html.Div("Show channel table")],
                                                                          style={"display": "flex",
                                                                                 "margin-top": "10px"}),
                                                       id="show-channel-collapse",
                                                       className="mx-auto", color=None, n_clicks=0,
                                                       style={"display": "flex", "width": "90%",
                                                              "align-items": "center",
                                                              "float": "center", "justify-content": "center"}),
                                            html.Div(dbc.Collapse(
                                                html.Div([dbc.Button(
                                                    children=html.Span([html.I(className="fa-solid fa-list-check",
                                                                               style={"display": "inline-block",
                                                                                      "margin-right": "3px"}),
                                                                        html.Div("Set blend order"),
                                                                        ]),
                                                    id="set-sort",
                                                    color=None, n_clicks=0, className="mx-auto",
                                                    style={"display": "flex", "width": "auto", "align-items": "center",
                                                           "float": "center", "justify-content": "center",
                                                           "margin-top": "-10px"}),
                                                    dag.AgGrid(
                                                        id='blend-options-ag-grid',
                                                        rowData=[],
                                                        columnDefs=[{'field': 'Channel', 'rowDrag': True}],
                                                        defaultColDef={"sortable": False, "filter": False},
                                                        columnSize="sizeToFit", style={"height": None},
                                                        dashGridOptions={
                                                            "rowDragManaged": True,
                                                            "animateRows": True,
                                                            # "rowDragMultiRow": True,
                                                            # "rowSelection": "multiple",
                                                            # "rowDragEntireRow": True,
                                                            "pagination": False,
                                                            "domLayout": "autoHeight",
                                                            # "getRowId": False
                                                        })],
                                                    style={"width": "90%", "margin-left": "12.5px", "height": "auto"}),
                                                is_open=False, id='channel-list-collapse')),
                                            html.Br(),
                                        ])], style={"margin-top": "3px", "float": "center", "textAlign": "center"}),
                                ]),
                                dbc.Tab(label='Channel', tab_id='channel-config-tab',
                                    label_style={"color": DEFAULT_WIDGET_COLOUR}, children=[
                                    html.Div([html.H5("Channel modification",
                                                      style={'width': '77.5%', "margin-top": "7.5px",
                                                             "text-align": "center"}),
                                              dbc.Button(
                                                  children=html.Span([html.I(className="fa-solid fa-circle-question",
                                                                             style={"display": "inline-block",
                                                                                    "margin-right": "7.5px",
                                                                                    "margin-top": "-5px"})],
                                                                     style={"display": "flex"}),
                                                  id="channel-mod-hover",
                                                  className="mb-3", color=None, n_clicks=0, style={"width": "20%",
                                                                                                   "margin-top": "3px",
                                                                                                   "margin-left": "-10px"},
                                                  external_link=True, target="_blank",
                                                  href="https://camlab-bioml.github.io/rakaia-doc/docs/pixel_analysis#channel-modification")],
                                             style={"display": "flex", "margin-top": "5px", "float": "center",
                                                    "textAlign": "center"}),
                                    dbc.Tooltip(TOOLTIPS['channel-mod'], target="channel-mod-hover"),
                                    dcc.Dropdown(id='images_in_blend', multi=False, style={"margin-top": "7.5px"},
                                    placeholder='Modify a channel in the current blend'),
                                    html.Br(),
                                    dmc.Center([dmc.ColorPicker(swatches=DEFAULT_SWATCHES,
                                                                swatchesPerRow=7, size='xs', withPicker=False,
                                                                id="swatch-color-picker",
                                                                fullWidth=False, persistence=config['persistence'],
                                                                persistence_type='local',
                                                                persisted_props='swatches')]),
                                    dbc.Button(children=html.Span([html.I(className="fa-solid fa-palette",
                                                                          style={"display": "inline-block",
                                                                                 "margin-right": "7.5px",
                                                                                 "margin-top": "3px"}),
                                                                   html.Div("Show/hide additional colors")],
                                                                  style={"display": "flex", "margin-top": "10px"}),
                                               id="show-color-picker",
                                               className="mx-auto", color="light", n_clicks=0,
                                               style={"display": "flex", "width": "auto", "align-items": "center",
                                                      "float": "center", "justify-content": "center"}),
                                    dbc.Collapse(html.Div([
                                        daq.ColorPicker(id="annotation-color-picker", label="Current channel color",
                                                        value=dict(hex="#00ABFC", rgb=None), size=200),
                                    ]), is_open=False, id='color-picker-collapse', style={"margin-top": "5px"}),
                                    dbc.Button(children=html.Span([html.I(className="fa-solid fa-signal",
                                                                          style={"display": "inline-block",
                                                                                 "margin-right": "7.5px",
                                                                                 "margin-top": "3px"}),
                                                                   html.Div("Show/hide pixel histogram")],
                                                                  style={"display": "flex", "margin-top": "10px"}),
                                               id="show-pixel-hist",
                                               className="mx-auto", color="light", n_clicks=0,
                                               style={"display": "flex", "width": "auto", "align-items": "center",
                                                      "float": "center", "justify-content": "center"}),
                                    html.Div(dbc.Collapse(html.Div([html.H6("Pixel histogram", style={'width': '75%'}),
                                                                    html.Div([dcc.Loading(dcc.Graph(id="pixel-hist",
                                                                                                    figure={
                                                                                                        'layout': dict(
                                                                                                            xaxis_showgrid=False,
                                                                                                            yaxis_showgrid=False,
                                                                                                            xaxis=XAxis(
                                                                                                                showticklabels=False),
                                                                                                            yaxis=YAxis(
                                                                                                                showticklabels=False),
                                                                                                            margin=dict(
                                                                                                                l=5,
                                                                                                                r=5,
                                                                                                                b=15,
                                                                                                                t=20,
                                                                                                                pad=0))},
                                                                                                    style={
                                                                                                        'width': '60vh',
                                                                                                        'height': '30vh',
                                                                                                        'margin-left': '-30px'},
                                                                                                    # config={"modeBarButtonsToAdd": ["drawrect", "eraseshape"],
                                                                                                    # keep zoom and pan bars to be able to modify the histogram view
                                                                                                    # 'modeBarButtonsToRemove': ['zoom', 'pan']
                                                                                                    # },
                                                                                                    config={
                                                                                                        'displaylogo': False},
                                                                                                    ), type="default",
                                                                                          fullscreen=False,
                                                                                          color=DEFAULT_WIDGET_COLOUR)])]),
                                                          id="pixel-hist-collapse", is_open=False),
                                             style={"minHeight": "100px", "float": "center", "justifyContent": "center"}),
                                    html.Div([
                                        dcc.RangeSlider(0, 100, 1, value=[None, None],
                                                        marks=dict([(i, str(i)) for i in range(0, 100, 25)]),
                                                        id='pixel-intensity-slider', allowCross=False,
                                                        tooltip={"placement": "top", "always_visible": False})],
                                        style={"width": "93%", "margin-left": "27px", "margin-top": "-50px",
                                               "float": "center", "justifyContent": "center"}),
                                    html.Div(
                                        [dbc.Button("Default scaling", id="set-default-rangeslider", className="me-1",
                                                    size="sm", color='dark', outline=True, style={"float": "left",
                                                                                                  "margin-right": "12.5px",
                                                                                                  "height": "50%"}),
                                         dcc.Checklist(options=[' Set range max to current upper bound'],
                                                       value=[], id="custom-slider-max",
                                                       labelStyle={"margin-left": "5px", "float": "right",
                                                                   "justify-content": "right"},
                                                       style={"width": "100%", "float": "right", "margin-left": "10px",
                                                              "margin-right": "5px",
                                                              "accent-color": DEFAULT_WIDGET_COLOUR})],
                                        style={"display": "flex", "margin": "20px"}),
                                    html.Div([dcc.Checklist(options=[' Apply/refresh filter'], value=[],
                                                            id="bool-apply-filter", style={"width": "85%",
                                                            "accent-color": DEFAULT_WIDGET_COLOUR}),
                                              dcc.Dropdown(['median', 'gaussian'], 'median', id='filter-type',
                                                           style={"width": "85%", "display": "inline-block"}),
                                              dcc.Input(id="kernel-val-filter", type="number", value=3,
                                                        style={"width": "50%"},
                                                        min=0, max=9, step=1, debounce=True),
                                              dcc.Input(id="sigma-val-filter", type="number", value=1,
                                                        style={"width": "50%"},
                                                        disabled=True, min=0, max=9, step=0.1, debounce=True)],
                                             style={"display": "inline-block", "margin": "20px",
                                                    "margin-top": "-10px"}),
                                    html.Br()
                                ])
                            ], style={"margin-left": "7.5px", "margin-right": "7.5px", "margin-top": "3px"},
                            active_tab='channel-config-tab'),
                                dbc.Offcanvas(id="blend-config-offcanvas", title="Apply additional canvas tools",
                                               placement="end", style={"width": "32%"}, backdrop=False, scrollable=True,
                                               is_open=False, children=[
                                dbc.Tabs(id='config-tabs',
                                children=[dbc.Tab(label="Configure", tab_id='blend-config-tab',
                                        label_style={"color": DEFAULT_WIDGET_COLOUR},
                                children=[
                                # need more space for multi options
                                dbc.Tabs(id='config-subtabs', children=[
                                    dbc.Tab(label='Canvas', label_style={"color": DEFAULT_WIDGET_COLOUR},
                                    children=[
                                        html.Br(),
                                        html.Div([
                                                  html.Div(
                                                      [html.H6("Scalebar length (unzoomed)", style={'width': '75%',
                                                        "margin-left": "30px"}),
                                                       dcc.Input(id="custom-scale-val", type="number", value=None,
                                                                 style={"width": "60%", "margin-left": "30px"},
                                                                 debounce=True)],
                                                      style={"display": "block", "float": "center"}),
                                                  html.Div([html.H6("Scale ratio\n(m/pixel)",
                                                                    style={'width': '75%', 'margin-left': '30px'}),
                                                            dcc.Input(id="pixel-size-ratio", type="number", value=1,
                                                                      style={"width": "60%", "margin-left": "30px"},
                                                                      persistence=config['persistence'],
                                                                      persistence_type='local', debounce=True)],
                                                           style={"display": "block", "float": "center"}),
                                            daq.ToggleSwitch(label='Invert annotation placement',
                                                             id='invert-annotations',
                                                             labelPosition='bottom', value=False,
                                                             color=DEFAULT_WIDGET_COLOUR,
                                                             style={"width": "30%", "margin-left": "5px",
                                                                    "textAlign": "center"},
                                                             persistence=config['persistence'],
                                                             persistence_type='local')
                                                  ], style={"display": "flex"}),
                                        html.Div(
                                            [html.Abbr(dcc.Checklist(options=[' Show channel intensities on hover'],
                                                                     value=[], id="channel-intensity-hover",
                                                                     style={"width": "100%",
                                                                            "accent-color": DEFAULT_WIDGET_COLOUR}),
                                                       title="WARNING: speed is significantly compromised with this feature, "
                                                             "particularly for large images.")], style={"display": "flex"}),
                                        html.Br(),
                                        html.H6("Adjust legend/scale size"),
                                        dcc.Slider(4, 30, 1, value=16,
                                                   id='legend-size-slider',
                                                   marks={4: 'small', 16: 'default', 30: 'large'},
                                                   persistence=config['persistence'], persistence_type='local'),
                                        html.Br(),
                                        html.H6("Apply global filter"),
                                        html.Div([dcc.Checklist(options=[' Apply/refresh filter'], value=[],
                                                                id="bool-apply-global-filter",
                                                                style={"width": "85%",
                                                                       "accent-color": DEFAULT_WIDGET_COLOUR}),
                                                  dcc.Dropdown(['median', 'gaussian'], 'median',
                                                               id='global-filter-type',
                                                               style={"width": "100%", "display": "inline-block"})],
                                                 style={"display": "flex", "margin": "20px"}),
                                        html.Div([dcc.Dropdown([1, 3, 5, 7, 9], 3, id='global-kernel-val-filter',
                                                               style={"width": "75%"}),
                                                  dcc.Input(id="global-sigma-val-filter", type="number", value=1,
                                                            style={"width": "60%"}, debounce=True,
                                                            disabled=True, min=0, max=9, step=0.1)],
                                                 style={"display": "flex", "margin": "20px"}),
                                        # dbc.Button("Reset all channels to default", id="set-default-rangeslider-all",
                                        #            className="me-1",
                                        #            size="sm", color='dark', outline=True,
                                        #            style={"float": "left", "margin-left": "20px", "height": "50%"}),
                                        # html.Br(),
                                        # html.Br(),
                                        html.H5("Mask configuration"),
                                        dcc.Loading(dcc.Dropdown(id='mask-options', multi=False,
                                        options=[], placeholder='Select mask',
                                        style={'width': '100%', 'display': 'inline-block',
                                            'margin-right': '-50', 'overflow-wrap': 'anywhere'}), type="default",
                                        fullscreen=False, color=DEFAULT_WIDGET_COLOUR),
                                        html.Br(),
                                        html.H6("Set mask opacity relative to channels"),
                                        dcc.Slider(0, 100, 2.5, value=35,
                                                   id='mask-blending-slider', marks={0: '0%', 25: '25%',
                                                                                     50: '50%', 75: '75%',
                                                                                     100: '100%'},
                                                   persistence=config['persistence'], persistence_type='local'),
                                        html.Div([html.Div([daq.ToggleSwitch(label='Apply mask', id='apply-mask',
                                            labelPosition='bottom', color=DEFAULT_WIDGET_COLOUR,
                                            style={"margin-left": "20px", "textAlign": "center", "width": "50%"},
                                            persistence=config['persistence'], persistence_type='local'),
                                                            dcc.Checklist(options=[' add boundary'],
                                                                                    value=[' add boundary'],
                                                                                    id="add-mask-boundary",
                                                                                    style={"margin-left": "10px",
                                                                                           "margin-top": "10px",
                                                                                           "accent-color": DEFAULT_WIDGET_COLOUR},
                                                            persistence=config['persistence'], persistence_type='local'),
                                                            dcc.Checklist(options=[' Show mask ID on hover'],
                                                                          value=[], id="add-cell-id-mask-hover",
                                                                          style={"margin-left": "10px",
                                                                                 "margin-top": "10px",
                                                                                 "accent-color": DEFAULT_WIDGET_COLOUR},
                                                        persistence=config['persistence'], persistence_type='local')],
                                                           style={"display": "flex", "width": "90%"}),
                                                  html.Br(),
                                                  dbc.Button("Refresh canvas", id="data-selection-refresh",
                                                             className="me-1",
                                                             size="sm", color='dark', outline=True,
                                                             style={"align-items": "center",
                                                                    "float": "center", "justify-content": "center",
                                                                    "height": "50%"}),
                                                  dbc.Tooltip(TOOLTIPS['roi-refresh'], target="data-selection-refresh"),
                                                  ])
                                    ]),
                                    dbc.Tab(label='Gating', label_style={"color": DEFAULT_WIDGET_COLOUR},
                                            children=[
                                                html.Br(),
                                                html.H6("Set gating categories (single/multiple)"),
                                                dcc.Dropdown(id='gating-channel-options', multi=True,
                                                placeholder='Gate objects on quantification/measurements',
                                                options=[], style={'width': '100%', 'display': 'inline-block',
                                                                    'margin-right': '-50'}),
                                                html.Br(),
                                                html.Br(),
                                                html.H6("Modify gating parameters (normalized range)"),
                                                dcc.Dropdown(id='gating-cur-mod', multi=False,
                                                placeholder='Modify above gating parameter(s)',
                                                options=[],style={'width': '100%', 'display': 'inline-block',
                                                                    'margin-right': '-50'}),
                                                html.Br(),
                                                html.Br(),
                                                html.Div([
                                                    dcc.RangeSlider(0, 1, 0.005, value=[0, 1],
                                                                    marks=dict(
                                                                        [(i, str(i)) for i in [0, 0.25, 0.5, 0.75, 1]]),
                                                                    id='gating-slider', allowCross=False,
                                                                    tooltip={"placement": "top",
                                                                             "always_visible": False}),
                                                    html.Br(),
                                                html.Div([
                                                dcc.RadioItems(['intersection', 'union'], 'union',
                                                id='gating-blend-type', style={"margin-top": "7.5px",
                                                "margin-left": "15px", "accent-color": DEFAULT_WIDGET_COLOUR,
                                                "width": "35%"}),
                                                daq.ToggleSwitch(label='Apply gating', id='apply-gating',
                                                labelPosition='bottom', value=False,
                                                color=DEFAULT_WIDGET_COLOUR,
                                                style={"width": "40%", "margin-left": "-10px", "margin-top": "2.5px"}),
                                                html.H6(children=[], id="gating-param-display", style={"width": "60%"}),
                                                ], style={"display": "flex", "width": "100%", "justifyContent": "center"}),
                                            html.Br(),
                                            html.Div([
                                                dcc.Input(type='text', value=None, debounce=True,
                                                          placeholder='Gate using object IDs in mask',
                                                          id='custom-id-gating', style={"width": "80%", "height": "40%"}),
                                                daq.ToggleSwitch(label='Gate on custom IDs', id='apply-gating-custom',
                                                                 labelPosition='bottom', value=False,
                                                                 color=DEFAULT_WIDGET_COLOUR,
                                                                 style={"width": "40%", "margin-left": "-10px",
                                                                        "margin-top": "-1.5px"}),
                                            ], style={"display": "flex", "width": "100%", "justifyContent": "center"}),
                                            html.Br(),
                                            html.H6("Annotate gated objects", style={"width": "75%"}),
                                            html.Div([dcc.Dropdown(id='quant-annotation-col-gating',
                                            multi=False, options=['object_annotation_1'],
                                            value="object_annotation_1", style={"width": "80%"}),
                                            dcc.Input(id="gating-annotation-assignment", type="text", value=None,
                                            placeholder="Add gating annotation",
                                            style={"width": "65%", "margin-left": "1px"})],
                                            style={"justifyContent": "center", "display": "flex"}),
                                            dbc.Button(children=html.Span([html.I(className="fa-solid fa-layer-group",
                                            style={"display": "inline-block", "margin-right": "7.5px", "margin-top": "3px"}),
                                            html.Div("Create gating annotation")], style={"display": "flex"}),
                                            id="gating-annotation-create", className="mx-auto", color=None, n_clicks=0,
                                            style={"margin-top": "10px"}),
                                            html.Br(),
                                            ]),
                                ]),
                                dbc.Tab(label='Marker/blend', label_style={"color": DEFAULT_WIDGET_COLOUR},
                                            children=[
                                html.Div([html.H5("Set blends", style={"margin-top": "15px"}),
                                dbc.Button(
                                children=html.Span([html.I(className="fa-solid fa-circle-question",
                                style={"display": "inline-block", "margin-right": "7.5px",
                                "margin-top": "-5px"})], style={"display": "flex"}),
                                id="set-blend-hover",
                                className="mb-3", color=None, n_clicks=0, style={"width": "20%", "margin-top": "10px",
                                    "margin-left": "12.5px"}),
                                dbc.Tooltip(TOOLTIPS['set-blends'], target="set-blend-hover")],
                                         style={"display": "flex", "float": "center"}),
                                html.Div([
                                dcc.Input(id="name-cur-blend", type="text", value=None,
                                    placeholder="save current blend", style={"width": "65%", "height": "175%",
                                                                     "margin-top": "15px"}),
                                dbc.Button("Save blend", id="save-cur-blend", className="me-1",
                                    style={"background-color": DEFAULT_WIDGET_COLOUR, "margin": "7px"})],
                                    style={"display": "flex"}),
                                html.Br(),
                                html.H6("Load saved blend"),
                                dcc.Dropdown(options=[], value=None, id='saved-blend-options',
                                        style={"width": "90%"}, multi=False),
                                html.Br(),
                                html.Br(),
                                html.H5("Marker correlation"),
                                html.Br(),
                                html.H6("Select target channel"),
                                dcc.Dropdown(options=[], value=None, id='target-channel-cor', multi=False),
                                html.Br(),
                                html.H6("Select baseline channel"),
                                dcc.Dropdown(options=[], value=None, id='baseline-channel-cor', multi=False),
                                html.Br(),
                                html.H6(children=[], id="marker-cor-display")],
                                style={"margin-top": "10px"}),
                                ]),
                                ]),
                                dbc.Tab(label="Annotate",
                                label_style={"color": DEFAULT_WIDGET_COLOUR},
                                tab_id='region-config-tab',
                                children=[html.H5('Regions', style={"margin-top": "10px"}),
                                dbc.Button(children=html.Span([html.I(className="fa-solid fa-chart-area",
                                style={"display": "inline-block", "margin-right": "7.5px", "margin-top": "3px"}),
                                html.Div("Show/hide region statistics")], style={"display": "flex"}),
                                id="compute-region-statistics", className="mx-auto", color=None, n_clicks=0,
                                style={"margin-top": "10px"}),
                                html.Div(dbc.Collapse(html.Div([html.H6("Selection information",
                                style={'width': '75%'}),
                                html.Div([dash_table.DataTable(id='selected-area-table',
                                columns=[{'id': p, 'name': p} for p in RegionStatisticGroups.columns],
                                data=None)], style={"width": "100%"}, className="region-stats")]),
                                id="area-stats-collapse", is_open=False), style={"margin-bottom": "0px", "margin-top": "20px"}),
                                html.Div([
                                dbc.Button(children=html.Span([html.I(className="fa-solid fa-layer-group",
                                style={"display": "inline-block", "margin-right": "7.5px", "margin-top": "3px"}),
                                    html.Div("Add region annotation")], style={"display": "flex"}),
                                               id="region-annotation", className="mx-auto", color=None, n_clicks=0,
                                               disabled=True, style={"margin-top": "5px"}),
                                dbc.Button(children=html.Span([html.I(className="fa-solid fa-rectangle-list",
                                    style={"display": "inline-block", "margin-right": "7.5px", "margin-top": "3px"}),
                                    html.Div("Show ROI annotations")], style={"display": "flex"}),
                                               id="show-annotation-table", className="mx-auto", color=None, n_clicks=0,
                                               style={"margin-top": "10px"}),
                                ], style={"display": "flex", "width": "50%"}),
                                html.Div([dbc.Button(children=html.Span([html.I(className="fa-solid fa-trash",
                                style={"display": "inline-block","margin-right": "7.5px","margin-top": "3px"}),
                                html.Div("Clear annotation shapes")],style={"display": "flex"}),
                                id="clear-region-annotation-shapes", className="mx-auto", color=None, n_clicks=0,
                                disabled=False, style={"margin-top": "10px"}),
                                dbc.Button(children=html.Span([html.I(className="fa-solid fa-trash",
                                style={"display": "inline-block", "margin-right": "7.5px",
                                "margin-top": "3px"}), html.Div("Clear ROI annotations")],
                                style={"display": "flex"}), id="clear-annotation_dict",
                                className="mx-auto", color=None, n_clicks=0, style={"margin-top": "10px", "width": "80%"})],
                                style={"display": "flex", "width": "50%"}),
                                html.Br(),
                                html.Br(),
                                html.Div([
                                html.H5('Click-point/coordinates', style={"float": "left", "justifyContent": "left"}),
                                daq.ToggleSwitch(label='Enable click annotation', id='enable_click_annotation',
                                                     labelPosition='bottom', value=False, color=DEFAULT_WIDGET_COLOUR,
                                                     style={"width": "45%", "margin-left": "17.5px", "float": "right",
                                                    "justifyContent": "right", "textAlign": "center"}),
                                ], style={"display": "flex", "width": "100%"}),
                                html.Br(),
                                html.Div([
                                dcc.Dropdown(id='annotation-cat-click',
                                    multi=False, options=['object_annotation_1'],
                                    value="object_annotation_1", style={"width": "80%"}),
                                dcc.Input(id="click-annotation-assignment", type="text", value=None,
                                          placeholder="Click annotation name",
                                    style={"width": "60%"})], style={"display": "flex"}),
                                html.Div([
                                dcc.Checklist(options=[' Overlay grid'], value=[], id="overlay-grid-canvas",
                                        style={"margin-top": "12px", "accent-color": DEFAULT_WIDGET_COLOUR}),
                                dcc.Checklist(options=[' Add circle on click'], value=[' Add circle on click'],
                                        id="click-annotation-add-circle", style={"margin-top": "12px", "margin-left": "30px",
                                                            "accent-color": DEFAULT_WIDGET_COLOUR}),
                                ], style={"display": "flex", "float": "center", "justifyContent": "center",
                                          "margin-top": "5px"}),
                                html.Br(),
                                dbc.Alert([], color='success', is_open=False, duration=1200, id='click-annotation-alert'),
                                dbc.Modal(children=dbc.ModalBody(
                                [dash_table.DataTable(id='annotation-table', columns=[], data=None, editable=False,
                                filter_action='native', row_selectable='multi', column_selectable='multi'),
                                html.Br(),
                                dbc.Button("Delete selected annotation(s)", id='delete-annotation-tabular',
                                           style={"background-color": DEFAULT_WIDGET_COLOUR})
                                 ]),
                                    id="annotation-preview", size='xl'),
                                html.Br(),
                                html.B("Set canvas position"),
                                          html.Div([
                                              dcc.Input(id="set-x-auto-bound", type="number", value=None,
                                                        placeholder="Set x-coord",
                                                        style={"margin-top": "7px", "width": "35%"}
                                                        ),
                                              dcc.Input(id="set-y-auto-bound", type="number", value=None,
                                                        placeholder="Set y-coord",
                                                        style={"margin-left": "10px",
                                                               "margin-top": "7px", "width": "35%"}),
                                              dbc.Button(
                                                  html.Span(
                                                      [html.Div("Set", style={"margin-right": "5px", "height": "150%",
                                                                              "font-size": "16px"}),
                                                       html.I(className="fa-solid fa-location-dot",
                                                              style={"display": "inline-block", "textAlign": "center",
                                                                     "margin-right": "7.5px", "margin-top": "3px"}),
                                                       ],
                                                      style={"display": "flex"}), id="activate-coord",
                                                  color=None, n_clicks=0,
                                                  style={"float": "center", "margin-top": "15px",
                                                         "justifyContent": "center"}),
                                          ], style={"display": "flex", "textAlign": "center", "width": "100%",
                                                    "margin": "3px", "padding": "3px", "float": "center",
                                                    "justifyContent": "center"}),
                                dbc.Modal(children=dbc.ModalBody(
                                [dbc.Row([dbc.Col([html.H6("Create a region annotation")], width=8),
                                          dbc.Col([html.H6("Add object annotation")], width=4)]),
                                 dbc.Row([dbc.Col([html.Div([dcc.Input(id="new-annotation-col", type="text",
                                value="", placeholder="Create annotation category",
                                style={"width": "50%", "margin-right": "10px", "height": "50%"}),
                                dbc.Button("Add new annotation category", id="add-annotation-col",
                                className="me-1", style={"margin-top": "-10px",
                                                         "background-color": DEFAULT_WIDGET_COLOUR})],
                                                            style={"display": "flex"})], width=8),
                                dbc.Col([dcc.Dropdown(id='quant-annotation-col',
                                multi=False, options=['object_annotation_1'],
                                    value="object_annotation_1")], width=4)]),
                                html.Br(),
                                dbc.Row([dbc.Col([html.Div([dcc.Input(id="region-annotation-name", type="text",
                                value="", placeholder="Annotation title (for PDF only)",
                                style={"width": "65%", "margin-right": "10px", "height": "50%"}),
                                dcc.Input(id="region-annotation-body", type="text",
                                value="", placeholder="Annotation description (for PDF only)",
                                          style={"width": "65%", "margin-right": "10px", "height": "50%"})],
                                style={"display": "flex"})], width=8),
                                dbc.Col([
                                dcc.Input(id="region-annotation-cell-types", type="text",
                                value="", placeholder="Annotation object type", style={"width": "65%", "margin-right": "10px",
                                    "height": "100%"})
                                ], width=4)]),
                                dbc.Row(dbc.Col(html.Div([], style={"display": "flex"}))),
                                html.Br(),
                                dcc.Checklist(id="bulk-annotate-shapes", value=[],
                                    options=[' annotate all current shapes'],
                                    style={"accent-color": DEFAULT_WIDGET_COLOUR}),
                                dbc.Button("Create annotation", id="create-annotation",
                                className="me-1", style={"margin-top": "10px",
                                "background-color": DEFAULT_WIDGET_COLOUR})]),
                                id="region-annotation-modal", size='xl', style={"margin-left": "10px",
                                "margin-top": "15px"}),
                                html.Br(),
                                ], style={"padding": "5px"}),
                                dbc.Tab(label="Measure/cluster", label_style={"color": DEFAULT_WIDGET_COLOUR},
                                    children=[
                                html.Br(),
                                html.Div([dbc.Button("Quantify current ROI", id="quantify-cur-roi-button",
                                           style={"background-color": DEFAULT_WIDGET_COLOUR, "margin-right": "10px"}),
                                dbc.Button("Re-import annotations into quant", id="quant-annot-reimport",
                                style={"background-color": DEFAULT_WIDGET_COLOUR, "margin-left": "10px"}, size='sm')],
                                style={"display": "flex", "justifyContent": "center"}),
                                dbc.Tooltip(TOOLTIPS['annot-reimport'], target="quant-annot-reimport"),
                                html.Br(),
                                html.Div([
                                du.Upload(id='upload-cluster-annotations', max_file_size=10000,
                                text='Import cluster annotations in CSV format',
                                chunk_size=100, max_total_size=10000, max_files=1, filetypes=['csv'],
                                default_style={"height": "3vh"})]),
                                html.Div([daq.ToggleSwitch(label='Apply clustering',
                                id='toggle-cluster-annotations', labelPosition='bottom', color=DEFAULT_WIDGET_COLOUR,
                                style={"margin-right": "15px", "margin-top": "10px", 'justifyContent': 'center',
                                       'textAlign': "center"}),
                                dcc.RadioItems(['mask', 'circles'], 'mask', id='cluster-annotation-type',
                                style={"margin-top": "7.5px", "margin-left": "15px", 'float': 'center',
                                'justifyContent': 'center', "accent-color": DEFAULT_WIDGET_COLOUR, 'width': '25%'}),
                                daq.ToggleSwitch(label='Clustering in legend',
                                    id='cluster-annotations-legend', labelPosition='bottom',
                                    color=DEFAULT_WIDGET_COLOUR, style={"margin-left": "25px", "float": "center",
                                    'justifyContent': 'center',
                                    "margin-right": "15px", "margin-top": "10px", 'textAlign': "center"}),
                                dbc.Button(children=html.Span([html.I(className="fa-solid fa-circle-question",
                                    style={"display": "inline-block", "margin-right": "7.5px",
                                        "margin-top": "-5px"})], style={"display": "flex"}),
                                    id="cluster-proj-info", className="mb-3", color=None, n_clicks=0,
                                    style={"width": "20%", "margin-top": "10px", "margin-left": "12.5px"}),
                                dbc.Tooltip(TOOLTIPS['cluster-proj'], target="cluster-proj-info", placement='bottom')],
                                style={"display": 'flex', 'margin-left': '10px', 'margin-top': '7.5px'}),
                                html.Br(),
                                html.Div([
                                    dcc.Dropdown(id='cluster-col', options=[], multi=False,
                                                 placeholder='Select cluster category',
                                                 style={"width": "90%", "float": "center"}),
                                    dbc.Button("Cluster distribution", id="toggle-cluster-dist",
                                               style={"background-color": DEFAULT_WIDGET_COLOUR,
                                                      "margin-right": '7.5px'}),
                                ], style={"display": "flex", "float": "center"}),
                                html.Br(),
                                dbc.Row(children=[
                                    dbc.Col(width=6, children=[
                                        dcc.Dropdown(id='cluster-label-list', multi=False, options=[],
                                                     style={'width': '100%', 'margin-top': '10px', "margin-left": "5px"},
                                                     placeholder='Change cluster colors'),
                                        html.Br(),
                                        dcc.Checklist(id="toggle-clust-selection", value=[' select/deselect all'],
                                                      options=[' select/deselect all'],
                                                      style={"accent-color": DEFAULT_WIDGET_COLOUR,
                                                             "margin-left": "7.5px"}),
                                        dcc.Dropdown(id='cluster-label-selection', multi=True, options=[],
                                                     placeholder='Choose cluster categories',
                                                     style={'width': '100%', 'margin-left': '5px',
                                                            'margin-top': '15px'}),
                                    ], style={"display": "inline-block"}),
                                    dbc.Col(width=6, children=[
                                        daq.ColorPicker(id="cluster-color-picker", label="Current cluster color",
                                                        value=dict(hex="#00ABFC", rgb=None), size=150)
                                    ])
                                ]),
                                html.Br(),
                                dbc.Button("Show cluster labels", id="toggle-cluster-labels",
                                style={"background-color": DEFAULT_WIDGET_COLOUR, "margin-right": '7.5px'}),
                                dbc.Modal(children=dbc.ModalBody([dash_table.DataTable(id='clust-dist-table',
                                columns=[], data=None, editable=False, filter_action='native')]),
                                id="show-clust-dist-table", size='l'),
                                dbc.Collapse(html.Div([
                                html.Br(),
                                html.H6(children=[], id="cluster-assignments")]),
                                             is_open=False, id='cluster-label-collapse'),
                                dbc.Modal(id="quantification-roi-modal", children=dbc.ModalBody([
                                html.Div([dbc.Button("Quantify current ROI", id="quantify-cur-roi-execute",
                                           style={"background-color": DEFAULT_WIDGET_COLOUR, "margin-right": '7.5px'}),
                                html.B(id="mask-object-counter", style={"margin-left": '7.5px', 'margin-top': '7.5px'}),
                                dbc.Tooltip(TOOLTIPS['quantify-channels'], target="mask-object-counter")],
                                         style={"display": "flex", "justifyContent": "center"}),
                                html.Br(),
                                dcc.Checklist(id="quant-toggle-list", value=[' select/deselect all'],
                                options=[' select/deselect all'], style={"accent-color": DEFAULT_WIDGET_COLOUR}),
                                html.Br(),
                                html.H6("Select channels to quantify"),
                                dcc.Checklist(id="channel-quantification-list", value=[], options=[],
                                              style={"accent-color": DEFAULT_WIDGET_COLOUR}),
                                ])),
                                ])], style={"margin-top": "-15px"}),
                                     ]),
                                 html.Br()
                                 ],
                                style={"background-color": "#f8f9fa", "padding": "5px", "display": "inline-block",
                                       "float": "right", "width": "100%"},

                            ),

                        ], width=3),

                    ])])]),

            dbc.Tab(label="Channel gallery", tab_id='gallery-tab', id='gallery-tab',
                    label_style={"color": DEFAULT_WIDGET_COLOUR},
                        children=[dcc.Loading([
                            html.Div([daq.ToggleSwitch(label='Change thumbnail on zoom',
                        id='toggle-gallery-zoom', labelPosition='bottom', color=DEFAULT_WIDGET_COLOUR,
                                style={"margin-right": "15px", "margin-top": "10px", "textAlign": "center"}),
                                      dbc.Button("Update from zoom", id="chan-gallery-zoom-update",
                                                 className="mb-3", color='dark', n_clicks=0, outline=True,
                                                 style={"margin-top": "10px", "height": "50%"}),
                                    daq.ToggleSwitch(label='Default scaling',
                                                     value=True,
                                                             id='default-scaling-gallery', labelPosition='bottom',
                                                             color=DEFAULT_WIDGET_COLOUR, style={"margin-left": "15px",
                                                            "margin-top": "10px", "textAlign": "center"}),
                                    dbc.Row(dbc.Col(width=12, children=[
                                        dcc.Dropdown(id='unique-channel-list', multi=False, options=[],
                                                     placeholder='View a channel across multiple ROIs',
                                                     style={'width': '85%', 'display': 'inline-block',
                                                            'margin-left': '15px', "margin-top": "10px"}),
                                        daq.ToggleSwitch(label='View gallery by channel',
                                                         id='toggle-gallery-view', labelPosition='bottom',
                                                         color=DEFAULT_WIDGET_COLOUR,
                                                         style={"margin-right": "7px", "margin-top": "10px",
                                                                "textAlign": "center"}),
                                        dbc.Button(
                                            children=html.Span([html.I(className="fa-solid fa-circle-question",
                                                                       style={"display": "inline-block",
                                                                              "margin-right": "7.5px",
                                                                              "margin-top": "-5px"})],
                                                               style={"display": "inline-block"}),
                                            id="gallery-help-hover",
                                            className="mb-3", color=None, n_clicks=0,
                                            style={"width": "10%", "margin-top": "10px", "margin-left": "10px",
                                                   "float": "left", "justifyContent": "left", "display": "flex"}),
                                    dbc.Tooltip(TabText().channel_tiles, target="gallery-help-hover",
                                                placement='right')
                                    ], style={"display": "flex", "width": "70%"}),
                                    style={"display": "flex", "width": "70%"})],
                                           style={"display": "flex"}),
                        html.Div(id="image-gallery", children=[
                        dbc.Row(id="image-gallery-row")], style={"margin-top": "15px"}),
                        ], type="default", fullscreen=True, color=DEFAULT_WIDGET_COLOUR)]),
            dbc.Tab(label="Panel info", tab_id='panel-tab', label_style={"color": DEFAULT_WIDGET_COLOUR},
                    children=
                        [html.Div([dbc.Row([
                        dbc.Col(html.Div([
                        html.B("Panel information", style={"margin-top": "10px", "margin-left": "7.5px"}),
                        dbc.Button(
                                children=html.Span([html.I(className="fa-solid fa-circle-question",
                                                           style={"display": "inline-block",
                                                                  "margin-right": "7.5px"})],
                                                   style={"display": "flex"}),
                                id="panel-help-hover",
                                className="mb-3", color=None, n_clicks=0,
                                style={"width": "10%", "margin-top": "5px", "margin-left": "10px"}),
                            dbc.Tooltip(TabText().metadata, target="panel-help-hover",
                            style={"display": "flex"}),
                        html.Br(),
                        dash_table.DataTable(id='imc-panel-editable', columns=[], data=None,
                                            editable=True)]), width=9),
                        dbc.Col(html.Div([
                        html.Br()]),
                            width=3)])])]),
                          dbc.Tab(label="Quantification", tab_id='quantification-tab',
                                  label_style={"color": DEFAULT_WIDGET_COLOUR},
                                  children=[
                                html.Div([dbc.Row([
                                dbc.Col(html.Div([html.Br(),
                                html.Div([html.B("Heatmap", style={"margin-bottom": "10px", "margin=-left": "12.5px"}),
                                dbc.Button(children=html.Span([html.I(className="fa-regular fa-chart-bar",
                                        style={"display": "inline-block", "margin-right": "7.5px",
                                        "margin-top": "3px"}),
                                        html.Div("Heatmap options")], style={"display": "flex",
                                        "margin-top": "-5px", "margin-left": "15px"}),
                                        id="heatmap-config-button", className="mx-auto", color=None,
                                        n_clicks=0, style={"margin-top": "-5px", "justifyContent": "left"}),
                                dbc.Modal(children=dbc.ModalBody([
                                html.B("Heatmap settings"),
                                html.Br(),
                                html.Br(),
                                html.Div([
                                daq.ToggleSwitch(label='Normalize heatmap', id='normalize-heatmap',
                                        labelPosition='bottom', color=DEFAULT_WIDGET_COLOUR, value=True),
                                    html.Div([
                                    html.H6("Object count for sub-setting"),
                                        dcc.Input(type="number", placeholder="Subset heatmap", id="subset-heatmap",
                                                  step=1, value=50000, debounce=True,
                                                  style={"width": "50%", "height": "40%",
                                                         "margin-left": "30px", "margin-top": "5px"})
                                    ], style={"display": "inline-block"}),
                                ], style={"display": "flex", "float": "center", "textAlign": "center"})]),
                                id="heatmap-config-modal"),
                                ],
                                style={"display": "flex", "margin-bottom": "-15px", "justifyContent": "center"}),
                                    html.Br(),
                                    dcc.Graph(id="quantification-heatmap-full",
                                    figure={'layout': dict(xaxis_showgrid=False, autosize=False,
                                    yaxis_showgrid=False, xaxis=XAxis(showticklabels=False),
                                    yaxis=YAxis(showticklabels=False), margin=dict(l=5, r=5, b=15,
                                    t=20, pad=0))}, responsive=False, config={'displaylogo': False}),
                                    dcc.Checklist(options=[], value=[], id="quant-heatmap-channel-list",
                                    style={"margin-top": "12px", "accent-color": DEFAULT_WIDGET_COLOUR},
                                    inline=True, labelStyle={"margin": "0.12rem"}),
                                    html.Br(),
                                    html.Br(),
                                ]), width=6),
                                    dbc.Col(html.Div([html.Br(),
                                    html.Div([html.B("UMAP", style={"margin-top": "2.5px"}),
                                    dbc.Button(children=html.Span([html.I(className="fa-regular fa-chart-bar",
                                        style={"display": "inline-block", "margin-right": "7.5px",
                                            "margin-top": "3px"}),
                                    html.Div("UMAP options")], style={"display": "flex",
                                        "margin-top": "-5px","margin-left": "15px"}),
                                        id="umap-config-button", className="mx-auto", color=None, n_clicks=0,
                                        style={"margin-top": "-5px", 'float': "left"}),
                                    html.Div([
                                        dbc.Button("Show selection in dataset gallery", id="quantification-query-link",
                                                    style={"margin-right": "30px", "margin-bottom": "7px"},
                                                    color="dark", outline=True)
                                              ],
                                             style={"display": "flex", "justifyContent": "right"}),
                                              ], style={"display": "flex", "float": "center", "width": "100%"}),
                                        dbc.Modal(children=dbc.ModalBody([
                                        html.Div([
                                        dbc.Row([dbc.Col(width=6, children=[
                                        html.B("UMAP settings", style={"float": "left"}),
                                        ]),
                                        dbc.Col(width=3, children=[
                                            dbc.Button("Render UMAP", id="execute-umap-button", style={
                                                "margin-top": "-5px", "margin-left": "30px", "float": "left",
                                                "justifyContent": "left"}, color="dark", outline=True),
                                        ])])], style={"width": "auto"}),
                                        html.Br(),
                                        html.H6("Add annotation to UMAP"),
                                        dcc.Input(id="annotation-col-quantification", type="text",
                                        value="", placeholder="New annotation category",
                                        style={"width": "55%", "margin-right": "10px", "height": "100%",
                                               "margin-top": "5px"}),
                                        dbc.Button("Add new category", id="add-annot-col-quantification",
                                                       className="me-1", style={"margin-top": "10px",
                                        "background-color": DEFAULT_WIDGET_COLOUR}),
                                        dcc.Dropdown(id='quant-annotation-col-in-tab',
                                        multi=False, options=['object_annotation_1'],
                                            value="object_annotation_1", style={"width": "75%"}),
                                        dcc.Input(id="annotation-cell-types-quantification", type="text",
                                        value="", placeholder="New annotation type",
                                        style={"width": "55%", "margin-right": "10px", "height": "100%",
                                               "margin-top": "5px"}),
                                        dbc.Button("Annotate UMAP", id="create-annotation-umap",
                                            className="me-1", style={"margin-top": "10px",
                                            "background-color": DEFAULT_WIDGET_COLOUR}),
                                        dbc.Button("Current overlay -> Cluster", id="overlay-to-clust",
                                            className="me-1", style={"margin-top": "10px",
                                            "background-color": DEFAULT_WIDGET_COLOUR}),
                                        ]),
                                        id="umap-config-modal", size='l'),
                                    html.Div(
                                    [dbc.Row([dbc.Col([
                                        dcc.Loading(dcc.Dropdown(id='umap-projection-options', multi=False,
                                                                 options=[], style={"width": "100%"},
                                                                 placeholder="Select UMAP overlay"), type="default",
                                                    fullscreen=False,
                                                    color=DEFAULT_WIDGET_COLOUR),
                                    ], width=6),
                                    dbc.Col([
                                        dbc.Button(children=html.Span([html.I(className="fa-solid fa-table-list",
                                                                              style={"display": "inline-block",
                                                                                     "margin-right": "7.5px",
                                                                                     "margin-top": "3px"}),
                                                                       html.Div("Show overlay distribution")],
                                                                      style={"display": "flex", "margin-bottom": "5px",
                                                                             "margin-left": "15px"}),
                                                   id="show-quant-dist", className="mx-auto", color=None, n_clicks=0,
                                                   style={"float": "right", "justifyContent": "right", "margin-right": "30px"})
                                    ], width=5)])], style={"margin-top": "7.5px"}),
                                    dbc.Modal(children=dbc.ModalBody([dash_table.DataTable(id='quant-dist-table',
                                    columns=[], data=None, editable=False, filter_action='native')]),
                                    id="show-quant-dist-table", size='l'),
                                    html.Div([dcc.Graph(id="umap-plot", figure={'layout': dict(xaxis_showgrid=False,
                                    yaxis_showgrid=False, xaxis=XAxis(showticklabels=False),
                                    yaxis=YAxis(showticklabels=False), margin=dict(l=5, r=5, b=15,t=20, pad=0),
                                    autosize=False),
                                    }, responsive=False, config={'displaylogo': False}),
                                    html.Br()],
                                    id="umap-div-holder", style={"display": "None"}),
                                    ]), width=6),
                                    html.Br(),
                                    html.Br()
                                      ])], style={"margin-left": "10px", "margin-right": "10px"}),
                        dbc.Modal(children=dbc.ModalBody([html.H6("Select the object type annotation column"),
                        dcc.Dropdown(id='cell-type-col-designation',
                            multi=False, options=[], style={'width': '100%'})]),
                        id="quantification-config-modal", size='l', style={"margin-left": "10px",
                            "margin-top": "15px"})],
                                  ),
            dbc.Tab(label="Dataset gallery", tab_id='dataset-query', label_style={"color": DEFAULT_WIDGET_COLOUR},
                    children=[
                dbc.Row([dbc.Col(width=1, children=[
                    html.H6("Query number", style={"margin-top": "15px"}),
                    html.Div([dcc.Input(id="dataset-query-number", type="number",
                                        placeholder="Query number",
                                        value=3, style={"height": "25%", "width": "45%"}),
                              ],
                             style={"display": "flex", "margin-top": "15px"}),
                ]),
                dbc.Col(width=3, children=[html.H6("Dimension threshold(s) (optional)", style={"margin-top": "15px"}),
                html.Div([dcc.Input(id="dataset-query-dim-min", type="number",
                    placeholder="Dim. min", value=None, style={"height": "25%", "width": "40%",
                                                                         "margin-right": "5px"}),
                    dcc.Input(id="dataset-query-dim-max", type="number", placeholder="Dim. max", value=None,
                    style={"height": "25%", "width": "40%", "margin-left": "5px"})],
                    style={"display": "flex", "margin-top": "15px"})],
                style={"margin-left": "75px"}),
                dbc.Col(width=3, children=[html.H6("Query keyword (optional)", style={"margin-top": "15px"}),
                html.Div([dcc.Input(id="dataset-query-keyw", type="text",
                    placeholder="Query using ROI keyword", value=None, style={"height": "25%", "width": "85%",
                    "margin-right": "5px"})],
                style={"display": "flex", "margin-top": "15px"})], style={"margin-left": "20px"}),
                dbc.Col(width=2, children=[html.H6("Use saved blend (optional)", style={"margin-top": "15px"}),
                html.Div([dcc.Dropdown(options=[], value=None, id='saved-blend-options-roi', style={"width": "100%"},
                                             multi=False)],
                        style={"display": "flex", "margin-top": "15px"})],
                    style={"margin-left": "20px"}),
                dbc.Col(width=1, children=[
                    dbc.Button(
                        children=html.Span([html.I(className="fa-solid fa-circle-question",
                                                   style={"display": "inline-block",
                                                          "margin-right": "7.5px",
                                                          "margin-top": "-5px"})],
                                           style={"display": "flex"}),
                        id="roi-help-hover",
                        className="mb-3", color=None, n_clicks=0,
                        style={"width": "5%", "margin-top": "5px", "margin-left": "10px"}),
                    dbc.Tooltip(TabText().region_gallery, target="roi-help-hover",
                                style={"display": "flex"}),
                    dbc.Button(children=html.Span([html.I(className="fa-solid fa-bolt",
                                                          style={"display": "inline-block",
                                                                 "margin-right": "7.5px",
                                                                 "margin-top": "3px"}),
                                                   html.Div("Search ROIs")], style={"display": "flex"}),
                               id="execute-dataset-query",
                               className="mb-3", color="primary", n_clicks=0,
                               style={"margin-left": "10px", "margin-top": "5px",
                                      "background-color": DEFAULT_WIDGET_COLOUR})
                ])
                         ]),
                html.Div(id="dataset-query-gallery", children=[
                    dbc.Row(id="dataset-query-gallery-row"),
                    html.Br(),
                    dbc.Button("Load more...", id="dataset-query-additional-load", className="d-grid gap-2 col-3 mx-auto",
                               outline=True, color="dark",
                    style={"justifyContent": "center"}),
                    html.Br()], style={"margin-top": "15px", "display": "none"}),
            ]),
            # TODO: add tab for custom patient-level metadata exploration
            # dbc.Tab(label='Metadata', tab_id='custom-metadata', label_style={"color": DEFAULT_WIDGET_COLOUR},
            #     children=[])
                ], style={"margin-top": "0px"})
                          ])], id='tab-annotation', style={"margin": "0px"}),
        wrap_child_in_loading(dcc.Store(id="uploaded_dict"), wrap=config['use_loading']),
        # use a blank template for the lazy loading
        wrap_child_in_loading(dcc.Store(id="uploaded_dict_template"), wrap=config['use_loading']),
        dcc.Store(id="session_config"),
        dcc.Store(id="window_config"),
        dcc.Store(id="param_config"),
        dcc.Store(id="session_alert_config"),
        dcc.Store(id="blending_colours"),
        dcc.Store(id="image_presets"),
        dcc.Store(id="metadata_config"),
        dcc.Store(id="param_blend_config"),
        dcc.Store(id="anndata"),
        dcc.Store(id="image-metadata"),
        dcc.Store(id="canvas-layers"),
        dcc.Store(id="alias-dict"),
        dcc.Store(id="static-session-var"),
        dcc.Store(id="session_config_quantification"),
        wrap_child_in_loading(dcc.Store(id="quantification-dict"), wrap=config['use_loading']),
        dcc.Store(id="mask-dict"),
        dcc.Store(id="mask-uploads"),
        dcc.Store(id="figure-cache"),
        dcc.Store(id="uploads"),
        dcc.Store(id="uploads_cluster"),
        dcc.Store(id="current_canvas_image"),
        dcc.Store(id="umap-projection"),
        dcc.Store(id="annotations-dict"),
        dcc.Store(id="channel-order"),
        dcc.Store(id="umap-legend-categories"),
        dcc.Store(id="dataset-query-gallery-list"),
        dcc.Store(id="quantification-query-indices"),
        dcc.Store(id='cur-umap-subset-category-counts'),
        dcc.Store(id='cur_roi_dimensions'),
        dcc.Store(id='imported-annotations-csv'),
        dcc.Store(id='imported-cluster-frame'),
        dcc.Store(id='cluster-colour-assignments-dict'),
        dcc.Store(id="database-connection"),
        dcc.Store(id="db-saved-configs"),
        dcc.Store(id="gating-dict"),
        dcc.Store(id="gating-cell-list"),
        # maintain a list of cell ids for each ROI from the quant query to subset the mask
        dcc.Store(id='query-cell-id-lists'),
        dcc.Store(id='saved-blends'),
        dcc.Loading(dcc.Store(id="roi-query"), type="default", fullscreen=True, color=DEFAULT_WIDGET_COLOUR),
        EventListener(
            # https://developer.mozilla.org/en-US/docs/Web/API/Element/keydown_event
            events=[{"event": "keydown",
                     "props": ["keyCode", "key"]}],
            logging=True, id="keyboard-listener"
        ),
    ], style={"margin-left": "10px", "margin-right": "15px", "margin-top": "10px"}, className="dash-bootstrap")
