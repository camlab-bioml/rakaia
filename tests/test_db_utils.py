from ccramic.utils.db import (
    preview_dataframe_from_db_config_list,
    format_blend_config_document_for_insert,
    match_db_config_to_request_str,
    extract_alias_labels_from_db_document)
import pandas as pd
import datetime

def test_generate_config_preview_table():
    config_list = [{'_id': "ObjectId('658ef3180aa56bb30f0fcfde')",
                    'user': 'mattsdwatson', 'name': 'first_blend_config',
                    'channels': {'ArAr80': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Y89': {'color': '#00FF00', 'x_lower_bound': 0, 'x_upper_bound': 1, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'In113': {'color': '#FF0000', 'x_lower_bound': 2, 'x_upper_bound': 4, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'In115': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Xe131': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Xe134': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Ba136': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'La138': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Pr141': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd142': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd143': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd144': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd145': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd146': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Sm147': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd148': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Sm149': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd150': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Eu151': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Sm152': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Eu153': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Sm154': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Gd155': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Gd156': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Gd158': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Tb159': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Gd160': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Dy161': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Dy162': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Dy163': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Dy164': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Ho165': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Er166': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Er167': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Er168': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Tm169': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Er170': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Yb171': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Yb172': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Yb173': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Yb174': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Lu175': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Yb176': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Ir191': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Ir193': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Pt196': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Pb206': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}}, 'config': {'blend': ['Nd146', 'In113', 'Y89'], 'filter': {'global_apply_filter': [], 'global_filter_type': 'gaussian', 'global_filter_val': 3, 'global_filter_sigma': 1}}, 'modified': datetime.datetime(2023, 12, 29, 16, 25, 59, 712000)},
                   {'_id': "ObjectId('658ef3223e14178a98d340c4')", 'user': 'mattsdwatson', 'name': 'second_blend_config', 'channels': {'ArAr80': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Y89': {'color': '#00FF00', 'x_lower_bound': 0, 'x_upper_bound': 1, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'In113': {'color': '#FF0000', 'x_lower_bound': 2, 'x_upper_bound': 4, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'In115': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Xe131': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Xe134': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Ba136': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'La138': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Pr141': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd142': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd143': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd144': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd145': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd146': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Sm147': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd148': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Sm149': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Nd150': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Eu151': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Sm152': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Eu153': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Sm154': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Gd155': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Gd156': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Gd158': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Tb159': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Gd160': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Dy161': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Dy162': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Dy163': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Dy164': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Ho165': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Er166': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Er167': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Er168': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Tm169': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Er170': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Yb171': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Yb172': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Yb173': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Yb174': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Lu175': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Yb176': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Ir191': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Ir193': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Pt196': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}, 'Pb206': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None}}, 'config': {'blend': ['Nd146', 'In113', 'Y89'], 'filter': {'global_apply_filter': [], 'global_filter_type': 'gaussian', 'global_filter_val': 3, 'global_filter_sigma': 1}}, 'modified': "datetime.datetime(2023, 12, 29, 16, 26, 10, 607000)"}]

    frame = pd.DataFrame(preview_dataframe_from_db_config_list(config_list))
    assert len(frame) == 2
    assert list(frame['Names']) == ['first_blend_config', 'second_blend_config']

def test_basic_iteration_config_list():
    config_list = [{"name": "config_1", "blend": "insert_blend_here"}, {"name": "config_2", "blend": "new_blend"}]
    config_return = match_db_config_to_request_str(config_list, "config_1")
    assert config_return == {'name': 'config_1', 'blend': 'insert_blend_here'}
    assert match_db_config_to_request_str(config_list, "fake_key") is None

def test_create_insert_document_blend_config():
    blend_dict = {"ArAr80": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                             "filter_val": None, "filter_sigma": None},
                  "Y89": {"color": "#00FF00", "x_lower_bound": 0, "x_upper_bound": 1, "filter_type": None,
                          "filter_val": None, "filter_sigma": None},
                  "In113": {"color": "#FF0000", "x_lower_bound": 2, "x_upper_bound": 4, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "In115": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Xe131": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Xe134": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Ba136": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "La138": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Pr141": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Nd142": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Nd143": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Nd144": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Nd145": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Nd146": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Sm147": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Nd148": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Sm149": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Nd150": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Eu151": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Sm152": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Eu153": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Sm154": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Gd155": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Gd156": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Gd158": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Tb159": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Gd160": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Dy161": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Dy162": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Dy163": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Dy164": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Ho165": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Er166": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Er167": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Er168": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Tm169": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Er170": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Yb171": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Yb172": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Yb173": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Yb174": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Lu175": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Yb176": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Ir191": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Ir193": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Pt196": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None},
                  "Pb206": {"color": "#FFFFFF", "x_lower_bound": None, "x_upper_bound": None, "filter_type": None,
                            "filter_val": None, "filter_sigma": None}}

    aliases = {}
    for key in blend_dict.keys():
        aliases[key] = key
    channel_list = ["Nd146", "In113", "Y89"]
    global_apply_filter = []
    global_filter_type = "gaussian"
    global_filter_val = 3
    global_filter_sigma = 1
    document = format_blend_config_document_for_insert("fake_user", "first_config", blend_dict, channel_list,
                                                       global_apply_filter, global_filter_type, global_filter_val,
                                                       global_filter_sigma, None, None, aliases)
    assert document == {'user': 'fake_user', 'name': 'first_config', 'channels': {'ArAr80': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'ArAr80'}, 'Y89': {'color': '#00FF00', 'x_lower_bound': 0, 'x_upper_bound': 1, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Y89'}, 'In113': {'color': '#FF0000', 'x_lower_bound': 2, 'x_upper_bound': 4, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'In113'}, 'In115': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'In115'}, 'Xe131': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Xe131'}, 'Xe134': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Xe134'}, 'Ba136': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Ba136'}, 'La138': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'La138'}, 'Pr141': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Pr141'}, 'Nd142': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd142'}, 'Nd143': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd143'}, 'Nd144': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd144'}, 'Nd145': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd145'}, 'Nd146': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd146'}, 'Sm147': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Sm147'}, 'Nd148': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd148'}, 'Sm149': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Sm149'}, 'Nd150': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd150'}, 'Eu151': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Eu151'}, 'Sm152': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Sm152'}, 'Eu153': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Eu153'}, 'Sm154': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Sm154'}, 'Gd155': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Gd155'}, 'Gd156': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Gd156'}, 'Gd158': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Gd158'}, 'Tb159': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Tb159'}, 'Gd160': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Gd160'}, 'Dy161': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Dy161'}, 'Dy162': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Dy162'}, 'Dy163': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Dy163'}, 'Dy164': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Dy164'}, 'Ho165': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Ho165'}, 'Er166': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Er166'}, 'Er167': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Er167'}, 'Er168': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Er168'}, 'Tm169': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Tm169'}, 'Er170': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Er170'}, 'Yb171': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Yb171'}, 'Yb172': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Yb172'}, 'Yb173': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Yb173'}, 'Yb174': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Yb174'}, 'Lu175': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Lu175'}, 'Yb176': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Yb176'}, 'Ir191': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Ir191'}, 'Ir193': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Ir193'}, 'Pt196': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Pt196'}, 'Pb206': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Pb206'}}, 'config': {'blend': ['Nd146', 'In113', 'Y89'], 'filter': {'global_apply_filter': [], 'global_filter_type': 'gaussian', 'global_filter_val': 3, 'global_filter_sigma': 1}}, 'cluster': None}

    clusters = {"roi_1": {"cell_type_1": "#FFFFFF", "cell_type_2": "#FFFFFF"}}
    document_2 = format_blend_config_document_for_insert("fake_user", "first_config", blend_dict, channel_list,
                                                       global_apply_filter, global_filter_type, global_filter_val,
                                                       global_filter_sigma, "roi_1", clusters, aliases)

    assert document_2 == {'user': 'fake_user', 'name': 'first_config', 'channels': {'ArAr80': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'ArAr80'}, 'Y89': {'color': '#00FF00', 'x_lower_bound': 0, 'x_upper_bound': 1, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Y89'}, 'In113': {'color': '#FF0000', 'x_lower_bound': 2, 'x_upper_bound': 4, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'In113'}, 'In115': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'In115'}, 'Xe131': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Xe131'}, 'Xe134': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Xe134'}, 'Ba136': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Ba136'}, 'La138': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'La138'}, 'Pr141': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Pr141'}, 'Nd142': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd142'}, 'Nd143': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd143'}, 'Nd144': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd144'}, 'Nd145': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd145'}, 'Nd146': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd146'}, 'Sm147': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Sm147'}, 'Nd148': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd148'}, 'Sm149': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Sm149'}, 'Nd150': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Nd150'}, 'Eu151': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Eu151'}, 'Sm152': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Sm152'}, 'Eu153': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Eu153'}, 'Sm154': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Sm154'}, 'Gd155': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Gd155'}, 'Gd156': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Gd156'}, 'Gd158': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Gd158'}, 'Tb159': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Tb159'}, 'Gd160': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Gd160'}, 'Dy161': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Dy161'}, 'Dy162': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Dy162'}, 'Dy163': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Dy163'}, 'Dy164': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Dy164'}, 'Ho165': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Ho165'}, 'Er166': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Er166'}, 'Er167': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Er167'}, 'Er168': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Er168'}, 'Tm169': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Tm169'}, 'Er170': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Er170'}, 'Yb171': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Yb171'}, 'Yb172': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Yb172'}, 'Yb173': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Yb173'}, 'Yb174': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Yb174'}, 'Lu175': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Lu175'}, 'Yb176': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Yb176'}, 'Ir191': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Ir191'}, 'Ir193': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Ir193'}, 'Pt196': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Pt196'}, 'Pb206': {'color': '#FFFFFF', 'x_lower_bound': None, 'x_upper_bound': None, 'filter_type': None, 'filter_val': None, 'filter_sigma': None, 'alias': 'Pb206'}}, 'config': {'blend': ['Nd146', 'In113', 'Y89'], 'filter': {'global_apply_filter': [], 'global_filter_type': 'gaussian', 'global_filter_val': 3, 'global_filter_sigma': 1}}, 'cluster': {'cell_type_1': '#FFFFFF', 'cell_type_2': '#FFFFFF'}}


def test_extract_alias_labels():
    metadata_frame = pd.DataFrame({"channel": ['channel_1', 'channel_2'],
                                   'ccramic Label': ['channel_1', 'channel_2']})
    config = {"user": "user",
     "name": "test_config",
     "channels": {"channel_1": {"alias": "ch1"},
                  "channel_2": {"alias": "ch2"}},

     "config": {}}
    label_list = extract_alias_labels_from_db_document(config, metadata_frame)
    assert label_list ==[{'ccramic Label': 'ch1', 'channel': 'channel_1'},
        {'ccramic Label': 'ch2', 'channel': 'channel_2'}]

    config = {"user": "user",
              "name": "test_config",
              "channels": {"channel_1": {"alias": "ch1"},
                           "channel_2": {"alias": "ch2"},
                           "channel_3": {}},

              "config": {}}
    metadata_frame = pd.DataFrame({"channel": ['channel_1', 'channel_2', 'channel_3'],
                                   'ccramic Label': ['channel_1', 'channel_2', 'channel_3']})
    label_list = extract_alias_labels_from_db_document(config, metadata_frame)
    assert label_list == [{'ccramic Label': 'ch1', 'channel': 'channel_1'},
    {'ccramic Label': 'ch2', 'channel': 'channel_2'},
    {'ccramic Label': 'channel_3', 'channel': 'channel_3'}]

    assert extract_alias_labels_from_db_document({"user": "fake_user"}) is None
